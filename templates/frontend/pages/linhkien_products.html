{% extends 'frontend/components/layout.html' %} {% block content %}
<!-- BREADCRUMB -->
<div id="breadcrumb" class="section">
    <!-- container -->
    <div class="container">
        <!-- row -->
        <div class="row">
            <div class="col-md-12">
                <ul class="breadcrumb-tree">
                    <li><a href="{{ url_for('main.home') }}">Trang chủ</a></li>
                    <li class="active">Linh kiện máy tính</li>
                </ul>
            </div>
        </div>
        <!-- /row -->
    </div>
    <!-- /container -->
</div>
<!-- /BREADCRUMB -->

<!-- SECTION -->
<div class="section">
    <!-- container -->
    <div class="container">
        <!-- row -->
        <div class="row">
            <!-- ASIDE -->
            <div id="aside" class="col-md-3">
                <!-- aside Widget -->
                <div class="aside">
                    <h3 class="aside-title">Danh mục</h3>
                    <div class="checkbox-filter">
                        {% for category in categories %}
                        <div class="input-checkbox">
                            <input
                                type="checkbox"
                                id="category-{{ category.CategoryID }}"
                                onchange="filterProducts()"
                                data-category="{{ category.CategoryID }}"
                            />
                            <label for="category-{{ category.CategoryID }}">
                                <span></span>
                                {{ category.Name }}
                                <small
                                    >({{
                                    linhkien_products|selectattr('category.CategoryID',
                                    'equalto', category.CategoryID)|list|length
                                    }})</small
                                >
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <!-- /aside Widget -->

                <!-- aside Widget -->
                <div class="aside">
                    <h3 class="aside-title">Hãng sản xuất</h3>
                    <div class="checkbox-filter">
                        {% for brand in brands %}
                        <div class="input-checkbox">
                            <input
                                type="checkbox"
                                id="brand-{{ brand.BrandID }}"
                                onchange="filterProducts()"
                                data-brand="{{ brand.BrandID }}"
                            />
                            <label for="brand-{{ brand.BrandID }}">
                                <span></span>
                                {{ brand.Name }}
                                <small
                                    >({{
                                    linhkien_products|selectattr('brand.BrandID',
                                    'equalto', brand.BrandID)|list|length
                                    }})</small
                                >
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <!-- /aside Widget -->

                <!-- aside Widget -->
                <div class="aside">
                    <h3 class="aside-title">Tình trạng</h3>
                    <div class="checkbox-filter">
                        <div class="input-checkbox">
                            <input
                                type="checkbox"
                                id="in-stock"
                                onchange="filterProducts()"
                                data-stock="available"
                            />
                            <label for="in-stock">
                                <span></span>
                                Còn hàng
                                <small
                                    >({{ linhkien_products|selectattr('Stock',
                                    'gt', 5)|list|length }})</small
                                >
                            </label>
                        </div>
                        <div class="input-checkbox">
                            <input
                                type="checkbox"
                                id="low-stock"
                                onchange="filterProducts()"
                                data-stock="low"
                            />
                            <label for="low-stock">
                                <span></span>
                                Sắp hết
                                <small
                                    >({{ linhkien_products|selectattr('Stock',
                                    'le', 5)|selectattr('Stock', 'gt',
                                    0)|list|length }})</small
                                >
                            </label>
                        </div>
                        <div class="input-checkbox">
                            <input
                                type="checkbox"
                                id="out-of-stock"
                                onchange="filterProducts()"
                                data-stock="out"
                            />
                            <label for="out-of-stock">
                                <span></span>
                                Hết hàng
                                <small
                                    >({{ linhkien_products|selectattr('Stock',
                                    'equalto', 0)|list|length }})</small
                                >
                            </label>
                        </div>
                    </div>
                </div>
                <!-- /aside Widget -->
            </div>
            <!-- /ASIDE -->

            <!-- STORE -->
            <div id="store" class="col-md-9">
                <!-- store top filter -->
                <div class="store-filter clearfix">
                    <div class="store-sort">
                        <label>
                            Sắp xếp theo:
                            <select
                                class="input-select"
                                onchange="sortProducts(this.value)"
                            >
                                <option value="name-asc">Tên A-Z</option>
                                <option value="name-desc">Tên Z-A</option>
                                <option value="price-asc">
                                    Giá thấp đến cao
                                </option>
                                <option value="price-desc">
                                    Giá cao đến thấp
                                </option>
                                <option value="stock-desc">
                                    Tồn kho nhiều nhất
                                </option>
                            </select>
                        </label>
                    </div>
                    <ul class="store-grid">
                        <li class="active"><i class="fa fa-th"></i></li>
                        <li><i class="fa fa-th-list"></i></li>
                    </ul>
                </div>
                <!-- /store top filter -->

                <!-- store products -->
                <div class="row" id="products-container">
                    {% for product in linhkien_products %}
                    <div
                        class="col-md-4 col-xs-6 product-item"
                        data-category="{{ product.category.CategoryID if product.category else '' }}"
                        data-brand="{{ product.brand.BrandID if product.brand else '' }}"
                        data-stock="{{ product.Stock }}"
                        data-name="{{ product.Name }}"
                        data-price="{{ product.Price }}"
                    >
                        <div class="product">
                            <div class="product-img">
                                {% if product.ImageURL %}
                                <img
                                    src="{{ url_for('static', filename=product.ImageURL) }}"
                                    alt="{{ product.Name }}"
                                    style="object-fit: contain"
                                />
                                {% else %}
                                <div
                                    class="bg-light rounded d-flex align-items-center justify-content-center"
                                    style="height: 200px"
                                >
                                    <i
                                        class="fas fa-microchip fa-3x text-muted"
                                    ></i>
                                </div>
                                {% endif %}
                                <div class="product-label">
                                    {% if product.Stock == 0 %}
                                    <span class="sale">Hết hàng</span>
                                    {% elif product.Stock < 5 %}
                                    <span class="new">Sắp hết</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="product-body">
                                <p class="product-category">
                                    {{ product.category.Name if product.category
                                    else 'Chưa phân loại' }}
                                </p>
                                <h3 class="product-name">
                                    <a
                                        href="{{ url_for('main.product_detail', product_id=product.ProductID) }}"
                                        style="
                                            display: -webkit-box;
                                            -webkit-line-clamp: 2;
                                            -webkit-box-orient: vertical;
                                            overflow: hidden;
                                            text-overflow: ellipsis;
                                            line-height: 1.2em;
                                            height: 2.4em;
                                        "
                                        >{{ product.Name }}</a
                                    >
                                </h3>
                                <h4 class="product-price">
                                    {{ "{:,.0f}".format(product.Price) }} VNĐ
                                </h4>
                                <div class="product-rating">
                                    <i class="fa fa-star"></i>
                                    <i class="fa fa-star"></i>
                                    <i class="fa fa-star"></i>
                                    <i class="fa fa-star"></i>
                                    <i class="fa fa-star-o"></i>
                                </div>
                                <div class="product-btns">
                                    <button class="add-to-wishlist">
                                        <i class="fa fa-heart-o"></i
                                        ><span class="tooltipp">Yêu thích</span>
                                    </button>
                                    <button class="add-to-compare">
                                        <i class="fa fa-exchange"></i
                                        ><span class="tooltipp">So sánh</span>
                                    </button>
                                    <button class="quick-view">
                                        <i class="fa fa-eye"></i
                                        ><span class="tooltipp">Xem nhanh</span>
                                    </button>
                                </div>
                            </div>
                            <div class="add-to-cart">
                                {% if product.Stock > 0 %}
                                <a
                                    href="{{ url_for('main.add_to_cart', product_id=product.ProductID, quantity=1) }}"
                                    class="add-to-cart-btn"
                                >
                                    <i class="fa fa-shopping-cart"></i> Thêm vào
                                    giỏ hàng
                                </a>
                                {% else %}
                                <button class="add-to-cart-btn" disabled>
                                    <i class="fa fa-times"></i> Hết hàng
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <!-- /store products -->

                <!-- store bottom filter -->
                <div class="store-filter clearfix">
                    <span class="store-qty"
                        >Hiển thị {{ linhkien_products|length }} sản phẩm</span
                    >
                </div>
                <!-- /store bottom filter -->
            </div>
            <!-- /STORE -->
        </div>
        <!-- /row -->
    </div>
    <!-- /container -->
</div>
<!-- /SECTION -->

<script>
    function filterProducts() {
        const categoryFilters = Array.from(
            document.querySelectorAll("input[data-category]:checked"),
        ).map((cb) => cb.dataset.category);
        const brandFilters = Array.from(
            document.querySelectorAll("input[data-brand]:checked"),
        ).map((cb) => cb.dataset.brand);
        const stockFilters = Array.from(
            document.querySelectorAll("input[data-stock]:checked"),
        ).map((cb) => cb.dataset.stock);

        const products = document.querySelectorAll(".product-item");
        let visibleCount = 0;

        products.forEach((product) => {
            const category = product.dataset.category;
            const brand = product.dataset.brand;
            const stock = parseInt(product.dataset.stock);

            let show = true;

            // Filter by category
            if (
                categoryFilters.length > 0 &&
                !categoryFilters.includes(category)
            ) {
                show = false;
            }

            // Filter by brand
            if (brandFilters.length > 0 && !brandFilters.includes(brand)) {
                show = false;
            }

            // Filter by stock
            if (stockFilters.length > 0) {
                let stockMatch = false;
                for (const filter of stockFilters) {
                    if (filter === "available" && stock > 5) stockMatch = true;
                    if (filter === "low" && stock > 0 && stock <= 5)
                        stockMatch = true;
                    if (filter === "out" && stock === 0) stockMatch = true;
                }
                if (!stockMatch) show = false;
            }

            if (show) {
                product.style.display = "block";
                visibleCount++;
            } else {
                product.style.display = "none";
            }
        });

        document.querySelector(".store-qty").textContent =
            `Hiển thị ${visibleCount} sản phẩm`;
    }

    function sortProducts(sortBy) {
        const container = document.getElementById("products-container");
        const products = Array.from(
            container.querySelectorAll(".product-item"),
        );

        products.sort((a, b) => {
            switch (sortBy) {
                case "name-asc":
                    return a.dataset.name.localeCompare(b.dataset.name);
                case "name-desc":
                    return b.dataset.name.localeCompare(a.dataset.name);
                case "price-asc":
                    return (
                        parseFloat(a.dataset.price) -
                        parseFloat(b.dataset.price)
                    );
                case "price-desc":
                    return (
                        parseFloat(b.dataset.price) -
                        parseFloat(a.dataset.price)
                    );
                case "stock-desc":
                    return (
                        parseInt(b.dataset.stock) - parseInt(a.dataset.stock)
                    );
                default:
                    return 0;
            }
        });

        products.forEach((product) => container.appendChild(product));
    }

    function addToCart(productId) {
        // TODO: Implement add to cart functionality
        alert("Chức năng thêm vào giỏ hàng sẽ được triển khai sau!");
    }
</script>
{% endblock %}
